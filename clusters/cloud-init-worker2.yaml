#cloud-config

users:
  - default
  - name: kubernetes
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    shell: /bin/bash
    passwd: $6$rounds=4096$ZMReQfwhYfCWjz01$qdcmo5KGuMBWEzA.uSWnOI9NYC0nKpPvGQuWpeEvOVydAs5YFZDoPRXJ8vJCSGHyys4Ji6pCEJ.QwnHO0OJod0
    lock_passwd: Optional
    chpasswd: { expire: False }
    ssh_pwauth: True
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDWubnTq7KgZf+kXU1YCC0z+kFAlfUkIxIF0PWUdXo6Qopz1ofmZIyWpQ5t7Z/6Dn1bx/KAZ0KjXzMoYe9MwmdX7bjY0oz3LCgpK8dkIA3nYopNoDK1ZZsFVljP6xtKWA8OwtXCBj+7dHCq6MBPxnnQeU5SQXa1AyEVwDbRIPnC167E85HztTFvUOysTrlmW6XOFsGGnl6zk4mhJCPLgElBMg3NJvkJk8FgosiVG8PUA9RQJd7XmJ6GKcPQ4mHG+McK5JpjE/tmEE0piglLoKyZZzIIcd9g+0zATNMx5AAmP5OjmG/zroqw2KGpTigzyAlX/2pYmuvDIqFZ4LRb717wA10KQOPw0hTXZFDVvKQI48T6GM3pZL0EqWnVd6SRZXMhTIwsByy/fpK3lRJTXai4AyubmT0j5su40VoYpeAEFwVaVuNvbKkiz3Qvz+ZyOBmm5pQ+x5ioAriVmWt2mpBHyjpq+QyzycE28ObRCRxel3YtkUUQCndyasLZkzO3OE2k5ZInmDVP8PFtxfX+/plMV38mq7eBFxkrgcUVV73GkPjeq/fSizY2ylXV8eacPlGe4D2zS188pIxtPyVHrb9L3owkOlLtRGfZkYgFCHpjD8PsjqMZ8zHlPAvL2hivEI6dDVztLMmW2+PJBSfBuq3qLZ9/x6XE4BxjdZJRhnvdAw== darius@dezbateri

hostname: k8s-node-worker2
preserve_hostname: false

network:
  version: 2
  ethernets:
    ens3:
      dhcp4: true
      addresses:
        - 192.168.122.100/24
      gateway4: 192.168.122.1
      nameservers:
        addresses:
          - 8.8.8.8
          - 8.8.4.4

packages:
  - qemu-guest-agent
  - curl
  - apt-transport-https
  - ca-certificates
  - containerd

runcmd:
  - apt install -y wireguard
  - systemctl enable --now qemu-guest-agent
  - dhclient -v ens3
  - apt update
  - apt install docker.io -y
  - curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  - echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
  - apt update
  - apt install kubeadm kubelet kubectl -y
  - apt-mark hold kubeadm kubelet kubectl
  - kubeadm version
  - mkdir -p /etc/wireguard
  - wg genkey | tee /etc/wireguard/private.key | wg pubkey > /home/kubernetes/wg.pub
  - chmod 600 /etc/wireguard/private.key
  - chown kubernetes:kubernetes /etc/wireguard/wg.pub
  - echo "finished" > /home/kubernetes/finished.txt
  # - curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.32/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  # - echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.32/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
  # - apt-get update
  # - apt-get install -y kubelet kubeadm kubectl kubernetes-cni
  # - sudo apt-mark hold kubelet kubeadm kubectl
  # - systemctl enable --now kubelet
  # - echo "waiting for master to be ready..."
  # - until [ -f /root/kubeadm-join.sh ]; do sleep 5; done
  # - chmod +x /root/kubeadm-join.sh
  # - bash /root/kubeadm-join.sh